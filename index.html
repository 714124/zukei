import React, { useState, useEffect, useCallback } from 'react';
import { Trophy, RefreshCcw, Volume2, Lightbulb } from 'lucide-react';

const App = () => {
  const [currentStep, setCurrentStep] = useState('start');
  const [quizSet, setQuizSet] = useState([]);
  const [questionIndex, setQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null);
  const [isLocked, setIsLocked] = useState(false);
  const [showHint, setShowHint] = useState(false);

  // å…¨10å•ã®ãƒ‡ãƒ¼ã‚¿
  const allQuestions = [
    { question: 'ã“ã® å½¢ã® åå‰ã¯ ä½•ã‹ãªï¼Ÿ', visual: { type: 'shape', value: 'circle' }, options: ['ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã—ã‹ã', 'ãŠã»ã—ã•ã¾'], answer: 'ã¾ã‚‹', hint: 'ãŠã¤ãã•ã¾ã‚„ ãƒ‰ãƒ¼ãƒŠãƒ„ã¨ ãŠãªã˜ã ã‚ˆ' },
    { question: 'ã€Œã—ã‹ãã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ', visual: { type: 'text', value: 'ã©ã‚Œã‹ãªï¼Ÿ' }, options: ['â–³', 'ã€‡', 'â–¡', 'â˜†'], answer: 'â–¡', hint: 'ã‚«ãƒ‰ãŒ 4ã¤ ã‚ã‚‹ã‚‚ã®ã‚’ ã•ãŒã—ã¦ã­' },
    { question: 'ãŠã«ãã‚Šã¨ åŒã˜ å½¢ã¯ ã©ã‚Œã‹ãªï¼Ÿ', visual: { type: 'emoji', value: 'ğŸ™' }, options: ['ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã—ã‹ã', 'ãŠã¯ãª'], answer: 'ã•ã‚“ã‹ã', hint: 'ã‚«ãƒ‰ãŒ 3ã¤ ã‚ã‚‹ã‚ˆ' },
    { question: 'ã•ã‚“ã‹ãã‚’ 2ã¤ ã‚ã‚ã›ã‚‹ã¨ï¼Ÿ', visual: { type: 'composition', value: 'â–²â–²' }, options: ['ã¾ã‚‹', 'ã—ã‹ã', 'ãŠã»ã—ã•ã¾', 'ãªã¿ãªã¿'], answer: 'ã—ã‹ã', hint: 'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒã‚’ 2ã¤ ãã£ã¤ã‘ã‚‹ã¨â€¦ï¼Ÿ' },
    { question: 'ãƒ‰ãƒ¼ãƒŠãƒ„ã¨ åŒã˜ å½¢ã¯ ã©ã‚Œï¼Ÿ', visual: { type: 'emoji', value: 'ğŸ©' }, options: ['ã€‡', 'â–³', 'â–¡', 'â˜†'], answer: 'ã€‡', hint: 'ã‚ãªãŒ ã‚ã„ãŸ ã¾ã‚‹ã ã­' },
    { question: 'ã€Œã¾ã‚‹ã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ', visual: { type: 'text', value: 'ã•ãŒã—ã¦ã¿ã¦ã­' }, options: ['â–¡', 'â–³', 'ã€‡', 'â˜†'], answer: 'ã€‡', hint: 'ã‚«ãƒ‰ãŒãªã„ ã¤ã‚‹ã¤ã‚‹ã® å½¢ã ã‚ˆ' },
    { question: 'ã€Œã•ã‚“ã‹ãã€ã‚’ ã•ãŒãã†ï¼', visual: { type: 'text', value: 'ã©ã‚Œã‹ãªï¼Ÿ' }, options: ['ã€‡', 'â–¡', 'â˜†', 'â–³'], answer: 'â–³', hint: 'ãƒ¨ãƒƒãƒˆã® ã»ã‚„ã€ãŠã‚„ã¾ã® å½¢ã ã‚ˆ' },
    { question: 'ãƒ†ãƒ¬ãƒ“ã¨ åŒã˜ å½¢ã¯ ã©ã‚Œï¼Ÿ', visual: { type: 'emoji', value: 'ğŸ“º' }, options: ['ã—ã‹ã', 'ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ãŠã¯ãª'], answer: 'ã—ã‹ã', hint: 'ã¾å››è§’ã„ ã‹ãŸã¡ã ã­' },
    { question: 'ã€Œã¯ã‚“ã¶ã‚“ã® ã¾ã‚‹ã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ', visual: { type: 'text', value: 'ã‚¹ã‚¤ã‚«ã® ã‹ãŸã¡' }, options: ['ã€‡', 'D', 'â–³', 'â–¡'], answer: 'D', hint: 'ã¾ã‚‹ã‚’ ã¾ã‚“ä¸­ã§ ãã£ãŸã‚ˆ' },
    { question: 'ã—ã‹ãã‚’ 2ã¤ ã¤ãªã’ã‚‹ã¨ï¼Ÿ', visual: { type: 'composition', value: 'â– â– ' }, options: ['ãªãŒã„ ã—ã‹ã', 'ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã°ã¤'], answer: 'ãªãŒã„ ã—ã‹ã', hint: 'ãƒã‚¹ã‚„ ã§ã‚“ã—ã‚ƒã® ã‹ãŸã¡ã ã­' }
  ];

  const playSound = useCallback((type) => {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      if (type === 'correct') {
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
      } else if (type === 'incorrect') {
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
      } else {
        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      }
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + (type === 'correct' ? 0.4 : 0.2));
    } catch (e) {
      console.log('Audio not supported or interaction needed');
    }
  }, []);

  const startNewQuiz = () => {
    playSound('click');
    const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
    setQuizSet(shuffled.slice(0, 5));
    setQuestionIndex(0);
    setScore(0);
    setFeedback(null);
    setIsLocked(false);
    setShowHint(false);
    setCurrentStep('quiz');
  };

  const handleAnswer = (option) => {
    if (isLocked) return;
    setIsLocked(true);
    const isCorrect = option === quizSet[questionIndex].answer;
    
    if (isCorrect) {
      setScore(s => s + 1);
      setFeedback('correct');
      playSound('correct');
    } else {
      setFeedback('incorrect');
      playSound('incorrect');
    }

    setTimeout(() => {
      setFeedback(null);
      setShowHint(false);
      if (questionIndex < quizSet.length - 1) {
        setQuestionIndex(i => i + 1);
        setIsLocked(false);
      } else {
        setCurrentStep('result');
      }
    }, 1500);
  };

  return (
    <div className="min-h-screen bg-sky-200 flex flex-col items-center justify-center p-4 font-sans text-gray-800 relative overflow-hidden">
      {/* èƒŒæ™¯è£…é£¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <style>{`
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-20px) rotate(10deg); } }
        @keyframes float-delayed { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-20px) rotate(-10deg); } }
        @keyframes yellow-pulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0px #fbbf24); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 30px #fbbf24); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } }
        .animate-float { animation: float 4s infinite ease-in-out; }
        .animate-float-delayed { animation: float-delayed 5s infinite ease-in-out; animation-delay: 1s; }
        .animate-yellow-pulse { animation: yellow-pulse 2s infinite ease-in-out; }
        .animate-shake { animation: shake 0.15s ease-in-out 0s 2; }
      `}</style>

      <div className="absolute top-[10%] left-[5%] text-6xl animate-float opacity-50">ğŸ˜ŠğŸŸ¡</div>
      <div className="absolute top-[20%] right-[10%] text-6xl animate-float-delayed opacity-50">ğŸ˜ŠğŸŸ¥</div>
      <div className="absolute bottom-[15%] left-[10%] text-6xl animate-float opacity-50">ğŸ˜ŠğŸ”º</div>

      <div className="w-full max-w-2xl bg-yellow-50 rounded-[3rem] shadow-2xl overflow-hidden border-[10px] border-white relative z-10">
        
        {/* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */}
        {currentStep === 'start' && (
          <div className="p-8 md:p-12 text-center space-y-8">
            <h1 className="text-4xl md:text-6xl font-black text-pink-500 tracking-tight">ãŸã®ã—ã„å›³å½¢ã‚¯ã‚¤ã‚º</h1>
            <p className="text-2xl md:text-3xl font-bold text-sky-500">ã¾ã‚‹ãƒ»ã•ã‚“ã‹ããƒ»ã—ã‹ã</p>
            <div className="bg-white rounded-full p-10 shadow-inner border-4 border-dashed border-sky-300 inline-block">
              <div className="text-8xl animate-bounce">ğŸ˜ŠğŸŸ¡</div>
            </div>
            <div>
              <button 
                onClick={startNewQuiz} 
                className="bg-orange-400 hover:bg-orange-500 text-white text-3xl md:text-4xl font-black py-6 px-12 rounded-full shadow-[0_8px_0_rgb(194,120,0)] transform active:translate-y-2 active:shadow-none transition-all"
              >
                ã¯ã˜ã‚ã‚‹ï¼
              </button>
            </div>
          </div>
        )}

        {/* ã‚¯ã‚¤ã‚ºç”»é¢ */}
        {currentStep === 'quiz' && (
          <div className="p-6 md:p-8 relative">
            <div className="flex justify-between items-center mb-4 px-2 font-bold text-blue-400">
              <span className="text-xl">{questionIndex + 1} / 5</span>
              <div className="flex gap-2">
                {[...Array(5)].map((_, i) => (
                  <div key={i} className={`w-4 h-4 rounded-full border-2 border-white ${i <= questionIndex ? 'bg-orange-400' : 'bg-white'}`} />
                ))}
              </div>
            </div>

            <div className="bg-white rounded-[2rem] p-6 shadow-md mb-6 border-4 border-sky-100 text-center relative">
              <h2 className="text-2xl md:text-3xl font-bold leading-tight text-blue-700">
                {quizSet[questionIndex].question}
              </h2>
              {/* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */}
              <button 
                onClick={() => {setShowHint(!showHint); playSound('click');}}
                className={`absolute -top-4 -right-2 p-2 rounded-full shadow-lg transition-colors ${showHint ? 'bg-yellow-400 text-white' : 'bg-white text-yellow-400'}`}
              >
                <Lightbulb size={24} />
              </button>
            </div>

            {/* ãƒ’ãƒ³ãƒˆè¡¨ç¤º */}
            {showHint && (
              <div className="mb-4 bg-yellow-100 border-2 border-yellow-200 p-3 rounded-2xl text-center text-yellow-700 font-bold animate-fade-in">
                ğŸ’¡ {quizSet[questionIndex].hint}
              </div>
            )}

            <div className="flex justify-center mb-8 h-40 md:h-52 items-center bg-white bg-opacity-60 rounded-3xl border-4 border-white">
              <div className="transform scale-125 md:scale-150">
                {quizSet[questionIndex].visual.type === 'shape' && (
                  <div className="w-24 h-24 rounded-full bg-yellow-400 border-4 border-white shadow-lg flex items-center justify-center text-3xl animate-yellow-pulse">ğŸ˜Š</div>
                )}
                {quizSet[questionIndex].visual.type === 'emoji' && (
                  <div className="text-8xl animate-bounce">{quizSet[questionIndex].visual.value}</div>
                )}
                {quizSet[questionIndex].visual.type === 'composition' && (
                  <div className="flex gap-2 items-center text-6xl font-black">
                    <span className={quizSet[questionIndex].visual.value === 'â–²â–²' ? 'text-green-500' : 'text-blue-500'}>{quizSet[questionIndex].visual.value[0]}</span>
                    <span className="text-2xl text-gray-300">+</span>
                    <span className={quizSet[questionIndex].visual.value === 'â–²â–²' ? 'text-green-500' : 'text-blue-500'}>{quizSet[questionIndex].visual.value[1]}</span>
                  </div>
                )}
                {quizSet[questionIndex].visual.type === 'text' && (
                  <div className="text-4xl font-black text-pink-400 animate-pulse">{quizSet[questionIndex].visual.value}</div>
                )}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4 md:gap-6">
              {quizSet[questionIndex].options.map((opt, idx) => (
                <button 
                  key={idx} 
                  onClick={() => handleAnswer(opt)} 
                  disabled={isLocked}
                  className={`py-6 md:py-8 px-2 rounded-[1.5rem] md:rounded-[2rem] text-2xl md:text-3xl font-black shadow-[0_6px_0_rgba(0,0,0,0.1)] transform active:translate-y-1 active:shadow-none transition-all border-4 border-white text-white
                    ${idx === 0 ? 'bg-green-400' : idx === 1 ? 'bg-orange-400' : idx === 2 ? 'bg-purple-400' : 'bg-sky-400'} 
                    ${isLocked ? 'opacity-50' : 'hover:brightness-105'}`}
                >
                  {opt}
                </button>
              ))}
            </div>

            {/* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (â­•/âŒ) */}
            {feedback && (
              <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-20 rounded-[2.5rem] animate-in fade-in zoom-in duration-300">
                <div className={`text-center ${feedback === 'correct' ? 'animate-bounce' : 'animate-shake'}`}>
                  <div className="text-[10rem] md:text-[12rem] drop-shadow-xl">{feedback === 'correct' ? 'â­•' : 'âŒ'}</div>
                  <p className={`text-5xl font-black ${feedback === 'correct' ? 'text-pink-500' : 'text-blue-500'}`}>
                    {feedback === 'correct' ? 'ã›ã„ã‹ã„ï¼ï¼' : 'ãŠã—ã„ï¼'}
                  </p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* çµæœç”»é¢ */}
        {currentStep === 'result' && (
          <div className="p-10 text-center space-y-8 bg-white">
            <div className="flex justify-center relative">
              <Trophy size={120} className="text-yellow-400 animate-yellow-pulse" />
              <div className="absolute -top-4 -right-4 text-5xl animate-ping">âœ¨</div>
            </div>
            <h2 className="text-4xl md:text-5xl font-black text-blue-600">ã‚„ã£ãŸã­ï¼</h2>
            <div className="bg-yellow-50 p-8 rounded-[2.5rem] border-4 border-yellow-200">
              <p className="text-6xl md:text-7xl font-black text-pink-500">{score} / 5</p>
              <p className="text-xl md:text-2xl font-bold text-gray-500 mt-2">ãœã‚“ã¶ ã§ããŸã‚ˆï¼</p>
            </div>
            <button 
              onClick={() => setCurrentStep('start')} 
              className="bg-sky-500 hover:bg-sky-600 text-white text-2xl md:text-3xl font-black py-5 px-10 rounded-full shadow-[0_8px_0_rgb(3,105,161)] transition-all flex items-center gap-4 mx-auto"
            >
              ã‚‚ã†ã„ã¡ã© <RefreshCcw size={32} />
            </button>
          </div>
        )}
      </div>

      <div className="mt-8 flex items-center gap-3 bg-white bg-opacity-60 px-6 py-2 rounded-full shadow-sm border border-white">
        <Volume2 className="text-blue-500" />
        <span className="font-bold text-blue-600">ãŠã¨ãŒ ãªã‚‹ã‚ˆï¼</span>
      </div>
    </div>
  );
};

export default App;
