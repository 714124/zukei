import React, { useState, useEffect } from 'react';
import { Trophy, Star, ArrowRight, RefreshCcw, Volume2, HelpCircle } from 'lucide-react';

const App = () => {
  const [currentStep, setCurrentStep] = useState('start'); 
  const [quizSet, setQuizSet] = useState([]);
  const [questionIndex, setQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null); 
  const [isLocked, setIsLocked] = useState(false);

  // å…¨å•é¡Œã®ãƒªã‚¹ãƒˆ
  const allQuestions = [
    {
      question: 'ã“ã® å½¢ã® åå‰ã¯ ä½•ã‹ãªï¼Ÿ',
      visual: { type: 'shape', value: 'circle' },
      options: ['ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã—ã‹ã', 'ãŠã»ã—ã•ã¾'],
      answer: 'ã¾ã‚‹',
      hint: 'ã“ã‚ã“ã‚ ã“ã‚ãŒã‚‹ã‚ˆ'
    },
    {
      question: 'ã€Œã—ã‹ãã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ',
      visual: { type: 'text', value: 'ã©ã‚Œã‹ãªï¼Ÿ' },
      options: ['â–³', 'ã€‡', 'â–¡', 'â˜†'],
      answer: 'â–¡',
      hint: 'ã‚«ãƒ‰ãŒ 4ã¤ ã‚ã‚‹ã‚ˆ'
    },
    {
      question: 'ãŠã«ãã‚Šã¨ åŒã˜ å½¢ã¯ ã©ã‚Œã‹ãªï¼Ÿ',
      visual: { type: 'emoji', value: 'ğŸ™' },
      options: ['ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã—ã‹ã', 'ãŠã¯ãª'],
      answer: 'ã•ã‚“ã‹ã',
      hint: 'ã‚«ãƒ‰ãŒ 3ã¤ ã‚ã‚‹ã‚ˆ'
    },
    {
      question: 'ã•ã‚“ã‹ãã‚’ 2ã¤ ã‚ã‚ã›ã‚‹ã¨ï¼Ÿ',
      visual: { type: 'composition', value: 'â–²â–²' },
      options: ['ã¾ã‚‹', 'ã—ã‹ã', 'ãŠã»ã—ã•ã¾', 'ãªã¿ãªã¿'],
      answer: 'ã—ã‹ã',
      hint: 'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒã‚’ 2ã¤ãã£ã¤ã‘ã‚‹ã¨â€¦ï¼Ÿ'
    },
    {
      question: 'ãƒ‰ãƒ¼ãƒŠãƒ„ã¨ åŒã˜ å½¢ã¯ ã©ã‚Œï¼Ÿ',
      visual: { type: 'emoji', value: 'ğŸ©' },
      options: ['ã€‡', 'â–³', 'â–¡', 'â˜†'],
      answer: 'ã€‡',
      hint: 'ã‚ãªãŒ ã‚ã„ãŸ ã¾ã‚‹ã ã‚ˆ'
    },
    {
      question: 'ã€Œã¾ã‚‹ã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ',
      visual: { type: 'text', value: 'ã•ãŒã—ã¦ã¿ã¦ã­' },
      options: ['â–¡', 'â–³', 'ã€‡', 'â˜†'],
      answer: 'ã€‡',
      hint: 'ã‚«ãƒ‰ãŒãªã„ ã¤ã‚‹ã¤ã‚‹ã®å½¢ã ã‚ˆ'
    },
    {
      question: 'ã€Œã•ã‚“ã‹ãã€ã‚’ ã•ãŒãã†ï¼',
      visual: { type: 'text', value: 'ã©ã‚Œã‹ãªï¼Ÿ' },
      options: ['ã€‡', 'â–¡', 'â˜†', 'â–³'],
      answer: 'â–³',
      hint: 'ã‚«ãƒ‰ãŒ 3ã¤ ã‚ã‚‹ã‚ˆ'
    },
    {
      question: 'ãƒ†ãƒ¬ãƒ“ã¨ åŒã˜ å½¢ã¯ ã©ã‚Œï¼Ÿ',
      visual: { type: 'emoji', value: 'ğŸ“º' },
      options: ['ã—ã‹ã', 'ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ãŠã¯ãª'],
      answer: 'ã—ã‹ã',
      hint: 'ã¾å››è§’ã„ ã‹ãŸã¡ã ã­'
    },
    {
      question: 'ã€Œã¯ã‚“ã¶ã‚“ã® ã¾ã‚‹ã€ã¯ ã©ã‚Œã‹ãªï¼Ÿ',
      visual: { type: 'text', value: 'ã‚¹ã‚¤ã‚«ã® ã‹ãŸã¡' },
      options: ['ã€‡', 'D', 'â–³', 'â–¡'],
      answer: 'D',
      hint: 'ã¾ã‚‹ã‚’ ã¾ã‚“ä¸­ã§ ãã£ãŸã‚ˆ'
    },
    {
      question: 'ã—ã‹ãã‚’ 2ã¤ ã¤ãªã’ã‚‹ã¨ï¼Ÿ',
      visual: { type: 'composition', value: 'â– â– ' },
      options: ['ãªãŒã„ ã—ã‹ã', 'ã¾ã‚‹', 'ã•ã‚“ã‹ã', 'ã°ã¤'],
      answer: 'ãªãŒã„ ã—ã‹ã',
      hint: 'ãƒã‚¹ã‚„ ã§ã‚“ã—ã‚ƒã® ã‹ãŸã¡ã ã­'
    }
  ];

  // å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°
  const startNewQuiz = () => {
    playSound('click');
    const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, 5); // æ¯å›5å•é¸ã¶
    setQuizSet(selected);
    setQuestionIndex(0);
    setScore(0);
    setFeedback(null);
    setIsLocked(false);
    setCurrentStep('quiz');
  };

  const playSound = (type) => {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    if (type === 'correct') {
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
      oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); 
      gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.5);
    } else if (type === 'incorrect') {
      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
      oscillator.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.3);
      gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.4);
    } else {
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.1);
    }
  };

  const handleAnswer = (option) => {
    if (isLocked) return;
    setIsLocked(true);

    const isCorrect = option === quizSet[questionIndex].answer;
    if (isCorrect) {
      setScore(score + 1);
      setFeedback('correct');
      playSound('correct');
    } else {
      setFeedback('incorrect');
      playSound('incorrect');
    }

    setTimeout(() => {
      setFeedback(null);
      if (questionIndex < quizSet.length - 1) {
        setQuestionIndex(questionIndex + 1);
        setIsLocked(false);
      } else {
        setCurrentStep('result');
      }
    }, 1500);
  };

  return (
    <div className="min-h-screen bg-sky-200 flex flex-col items-center justify-center p-4 font-sans text-gray-800 relative overflow-hidden">
      {/* èƒŒæ™¯ã®è£…é£¾ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆãµã‚ãµã‚ç§»å‹•ï¼‰ */}
      <div className="absolute top-[10%] left-[5%] text-6xl animate-float">ğŸ˜ŠğŸŸ¡</div>
      <div className="absolute top-[20%] right-[10%] text-6xl animate-float-delayed">ğŸ˜ŠğŸŸ¥</div>
      <div className="absolute bottom-[15%] left-[10%] text-6xl animate-float">ğŸ˜ŠğŸ”º</div>
      <div className="absolute bottom-[20%] right-[5%] text-6xl animate-float-delayed">âœ¨</div>
      <div className="absolute top-[40%] left-[2%] text-4xl opacity-50">â˜ï¸</div>
      <div className="absolute top-[60%] right-[2%] text-4xl opacity-50">â˜ï¸</div>

      {/* ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */}
      <div className="w-full max-w-2xl bg-yellow-100 rounded-[3rem] shadow-2xl overflow-hidden border-[12px] border-white relative z-10">
        
        {/* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */}
        {currentStep === 'start' && (
          <div className="p-10 text-center space-y-10">
            <div className="space-y-2">
              <h1 className="text-5xl md:text-6xl font-black text-pink-500 tracking-tighter drop-shadow-sm">
                ãŸã®ã—ã„å›³å½¢ã‚¯ã‚¤ã‚º
              </h1>
              <p className="text-3xl font-bold text-sky-500">ã¾ã‚‹ãƒ»ã•ã‚“ã‹ããƒ»ã—ã‹ã</p>
            </div>

            <div className="bg-white rounded-full p-12 shadow-inner border-4 border-dashed border-sky-300 inline-block">
               <div className="text-9xl animate-pulse">ğŸ˜ŠğŸŸ¡</div>
            </div>

            <div>
              <button
                onClick={startNewQuiz}
                className="bg-orange-400 hover:bg-orange-500 text-white text-4xl font-black py-8 px-16 rounded-full shadow-[0_10px_0_rgb(194,120,0)] transform active:translate-y-2 active:shadow-none transition-all inline-flex items-center gap-4"
              >
                ã¯ã˜ã‚ã‚‹ï¼
              </button>
            </div>
          </div>
        )}

        {/* ã‚¯ã‚¤ã‚ºç”»é¢ */}
        {currentStep === 'quiz' && quizSet.length > 0 && (
          <div className="p-6 md:p-8 relative">
            {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */}
            <div className="flex justify-between items-center mb-4 px-4 font-bold text-blue-400">
              <span>{questionIndex + 1} / 5</span>
              <div className="flex gap-2">
                {[...Array(5)].map((_, i) => (
                  <div key={i} className={`w-4 h-4 rounded-full ${i <= questionIndex ? 'bg-orange-400' : 'bg-white'}`} />
                ))}
              </div>
            </div>

            {/* é›²ã®ã‚ˆã†ãªå•é¡Œæ  */}
            <div className="bg-white rounded-[3rem] p-8 shadow-md mb-8 relative border-4 border-sky-100">
              <h2 className="text-3xl md:text-4xl font-bold text-center leading-tight text-blue-700">
                {quizSet[questionIndex].question}
              </h2>
            </div>

            {/* ä¸­å¤®ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒªã‚¢ */}
            <div className="flex justify-center mb-10 h-48 items-center bg-white bg-opacity-50 rounded-3xl border-4 border-white">
              {quizSet[questionIndex].visual.type === 'shape' && (
                <div className="w-36 h-36 rounded-full bg-yellow-400 border-8 border-white shadow-lg flex items-center justify-center text-5xl animate-pulse">
                  ğŸ˜Š
                </div>
              )}
              {quizSet[questionIndex].visual.type === 'composition' && (
                <div className="flex gap-2 items-center animate-bounce">
                   {quizSet[questionIndex].visual.value === 'â–²â–²' ? (
                     <>
                      <span className="text-8xl text-green-500 drop-shadow-md">â–²</span>
                      <span className="text-4xl text-gray-400">+</span>
                      <span className="text-8xl text-green-500 drop-shadow-md">â–²</span>
                     </>
                   ) : (
                     <>
                      <span className="text-8xl text-blue-500 drop-shadow-md">â– </span>
                      <span className="text-4xl text-gray-400">+</span>
                      <span className="text-8xl text-blue-500 drop-shadow-md">â– </span>
                     </>
                   )}
                </div>
              )}
              {quizSet[questionIndex].visual.type === 'emoji' && (
                <div className="text-[10rem] drop-shadow-xl animate-bounce">
                  {quizSet[questionIndex].visual.value}
                </div>
              )}
              {quizSet[questionIndex].visual.type === 'text' && (
                <div className="text-6xl font-black text-pink-400 animate-pulse">
                  {quizSet[questionIndex].visual.value}
                </div>
              )}
            </div>

            {/* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */}
            <div className="grid grid-cols-2 gap-6">
              {quizSet[questionIndex].options.map((opt, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswer(opt)}
                  disabled={isLocked}
                  className={`
                    py-8 px-4 rounded-[2rem] text-3xl font-black shadow-[0_8px_0_rgba(0,0,0,0.1)] transform active:translate-y-1 active:shadow-none transition-all border-4 border-white
                    ${idx === 0 ? 'bg-green-400 text-white' : ''}
                    ${idx === 1 ? 'bg-orange-400 text-white' : ''}
                    ${idx === 2 ? 'bg-purple-400 text-white' : ''}
                    ${idx === 3 ? 'bg-sky-400 text-white' : ''}
                    ${isLocked ? 'opacity-50 cursor-not-allowed' : 'hover:brightness-105'}
                  `}
                >
                  {opt}
                </button>
              ))}
            </div>

            {/* æ­£è§£ãƒ»ä¸æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */}
            {feedback && (
              <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-20 rounded-[2.5rem]">
                {feedback === 'correct' ? (
                  <div className="text-center animate-bounce">
                    <div className="text-[12rem] leading-none mb-4">â­•</div>
                    <p className="text-5xl font-black text-pink-500">ã›ã„ã‹ã„ï¼ï¼</p>
                  </div>
                ) : (
                  <div className="text-center animate-shake">
                    <div className="text-[12rem] leading-none mb-4">âŒ</div>
                    <p className="text-5xl font-black text-blue-500">ãŠã—ã„ï¼</p>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* çµæœç”»é¢ */}
        {currentStep === 'result' && (
          <div className="p-12 text-center space-y-10 bg-white">
            <div className="flex justify-center relative">
              <Trophy size={140} className="text-yellow-400 animate-yellow-pulse" />
              <div className="absolute -top-4 -right-4 text-6xl animate-ping">âœ¨</div>
            </div>
            <div className="space-y-4">
              <h2 className="text-5xl font-black text-blue-600">
                ã‚„ã£ãŸã­ï¼
              </h2>
              <div className="bg-yellow-100 p-8 rounded-[2.5rem] border-4 border-yellow-200">
                <p className="text-7xl font-black text-pink-500">{score} / 5</p>
                <p className="text-2xl font-bold text-gray-600 mt-2">ãœã‚“ã¶ ã§ããŸã‚ˆï¼</p>
              </div>
            </div>
            
            <button
              onClick={() => setCurrentStep('start')}
              className="bg-sky-500 hover:bg-sky-600 text-white text-3xl font-black py-6 px-12 rounded-full shadow-[0_8px_0_rgb(3,105,161)] transform active:translate-y-1 active:shadow-none transition-all inline-flex items-center gap-4"
            >
              ã‚‚ã†ã„ã¡ã© <RefreshCcw size={32} />
            </button>
          </div>
        )}
      </div>

      <div className="mt-8 flex items-center gap-4 bg-white bg-opacity-50 px-6 py-2 rounded-full shadow-sm">
        <Volume2 size={24} className="text-blue-500" />
        <span className="font-bold text-blue-600">ãŠã¨ãŒ ãªã‚‹ã‚ˆï¼</span>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes float {
          0%, 100% { transform: translateY(0) rotate(0); }
          50% { transform: translateY(-20px) rotate(10deg); }
        }
        @keyframes float-delayed {
          0%, 100% { transform: translateY(0) rotate(0); }
          50% { transform: translateY(-20px) rotate(-10deg); }
        }
        .animate-float { animation: float 4s infinite ease-in-out; }
        .animate-float-delayed { animation: float-delayed 5s infinite ease-in-out; animation-delay: 1s; }
        
        @keyframes yellow-pulse {
          0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0px #fbbf24); }
          50% { transform: scale(1.1); filter: drop-shadow(0 0 30px #fbbf24); }
        }
        .animate-yellow-pulse {
          animation: yellow-pulse 2s infinite ease-in-out;
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-15px); }
          75% { transform: translateX(15px); }
        }
        .animate-shake {
          animation: shake 0.15s infinite;
        }
      `}} />
    </div>
  );
};

export default App;
